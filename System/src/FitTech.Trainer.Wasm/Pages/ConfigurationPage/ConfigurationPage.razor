@page "/configurationpage"

@inject AppHeaderStateHandler AppHeaderStateHandler
@inject IInvitationService InvitationService
@inject IJSRuntime JS
@inject ILocalStorageService LocalStorageService
@inject ILogger<ConfigurationPage> Logger
@using System.Text.Json
@using Blazor.Heroicons
@using Blazored.LocalStorage
@using FitTech.ApiClient.Generated
@using FitTech.Trainer.Wasm.Services
@using FitTech.WebComponents.Components.AppHeader
@using FitTech.WebComponents.Components.Buttons
@using FitTech.WebComponents.Services
@inherits FitTech.WebComponents.Components.CancellableComponent
@using Color = FitTech.WebComponents.Styles.Enums.Color
@using Size = FitTech.WebComponents.Styles.Enums.Size

@layout ConfigurationLayout

<div class="flex flex-col gap-4">

    <div class="w-full mx-auto mt-6">
        <h1 class="text-4xl font-bold text-fittech-dark">Invitaciones enviadas</h1>
        <p class="text-fittech-gray-secondary mb-2">
            Las invitaciones Rechazadas o Aceptadas dejarán de mostrarse pasados 15 días
        </p>
    </div>

    <div class="w-full bg-fittech-gray-secondary rounded-xl border-2 border-fittech-green mx-auto shadow-sm">

        @if (items is not null && items.Any())
        {
            @foreach (var item in items)
            {
                <div class="relative flex items-center p-4 border-b border-b-fittech-green">

                    <span class="text-lg text-fittech-dark font-semibold">
                        @item.ClientEmail
                    </span>

                    <div class="absolute left-1/2 -translate-x-1/2 flex justify-center">
                        @if (item.Status == "Pending")
                        {
                            <span class="px-3 py-1 rounded-full border border-yellow-700 text-yellow-700 bg-white text-sm font-semibold">
                                Pendiente
                            </span>
                        }
                        else if (item.Status == "Expired")
                        {
                            <span class="px-3 py-1 rounded-full border border-b-red-500 text-amber-800 bg-white text-sm font-semibold">
                                Expirada
                            </span>
                        }
                        else if (item.Status == "InProgress")
                        {
                            <span class="px-3 py-1 rounded-full border border-b-purple-800 text-pink-950 bg-white text-sm font-semibold">
                                En Proceso
                            </span>
                        }
                        else if (item.Status == "Completed")
                        {
                            <span class="px-3 py-1 rounded-full border border-b-green-700 text-green-700 bg-white text-sm font-semibold">
                                Aceptada
                            </span>
                        }
                    </div>

                    <div class="ml-auto flex items-end gap-3">

                        @if (item.Status == "Pending")
                        {
                            <FitTechButton 
                                Color="Color.Secondary" 
                                Size="Size.Medium" 
                                Label="Cancelar"
                                Icon="@HeroiconName.Check"
                                OnClick="@(() => CancelInvitations(item.ClientEmail))" />

                            <FitTechButton 
                                Color="Color.Tertiary" 
                                Size="Size.Medium"
                                Label="@GetResendButtonText(item.ClientEmail)"
                                Disabled="@IsResendBlocked(item.ClientEmail)"
                                Icon="@HeroiconName.Check"
                                OnClick="@(() => TryResend(item.ClientEmail))" />
                        }
                        else if (item.Status == "InProgress")
                        {
                            <FitTechButton 
                                Color="Color.Error" 
                                Size="Size.Medium" 
                                Label="Cancelar"
                                Icon="@HeroiconName.Check" />
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="p-4 text-gray-500 text-center">
                No hay invitaciones en proceso, pendientes o expiradas.
            </div>
        }

    </div>
</div>

@code {

    private List<InvitationDto>? items;
    private readonly Dictionary<string, DateTime> resendBlockedUntil = new();
    private PeriodicTimer? _timer;
    private CancellationTokenSource _timerCts = new();

    private const string StorageKey = "resendBlockedUntil";

    protected override async Task OnInitializedAsync()
    {
        AppHeaderStateHandler.Clear();
        OnInitialized();
        
        await LoadBlockedTimesAsync();

        await GetInvitationAsync(CancellationToken.None);
        
        _timer = new PeriodicTimer(TimeSpan.FromSeconds(1));

        _ = Task.Run(async () =>
        {
            try
            {
                while (await _timer.WaitForNextTickAsync(_timerCts.Token))
                {
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (OperationCanceledException)
            {
                //no action
            }
        });
    }

    private async Task LoadBlockedTimesAsync()
    {
        try
        {
         var json = await LocalStorageService.GetItemAsync<string>(StorageKey);

            if (!string.IsNullOrEmpty(json))
             {
                var dict = JsonSerializer.Deserialize<Dictionary<string, DateTime>>(json);
                if (dict != null)
                {
                    resendBlockedUntil.Clear();
                    foreach (var kv in dict)
                        resendBlockedUntil[kv.Key] = kv.Value;
                }
             }
        }
        catch
        {
            //no action
        }
    }

    private async Task SaveBlockedTimesAsync()
    {
        var json = JsonSerializer.Serialize(resendBlockedUntil);
        await JS.InvokeVoidAsync("localStorage.setItem", StorageKey, json);
    }

    private async Task GetInvitationAsync(CancellationToken cancellationToken)
    {
        var response = await InvitationService.GetTrainerInvitationsAsync(cancellationToken);
        if (!response.Succeeded)
        {
            Logger.LogError($"Error getting invitations: {response}");
        }
        items = response.Value?.Invitations?.ToList() ?? new();
    }

    private async Task CancelInvitations(string clientEmail)
    {
        var response = await InvitationService.CancelInvitation(clientEmail, CancellationToken.None);

        if (response.Succeeded)
        {
            await GetInvitationAsync(CancellationToken.None);
            StateHasChanged();
        }
    }

    private async Task TryResend(string email)
    {
        var now = DateTime.Now;

        if (IsResendBlocked(email))
            return;

        var response = await InvitationService.ResendInvitation(email, CancellationToken.None);

        if (response.Succeeded)
        {
            resendBlockedUntil[email] = now.AddMinutes(1);
            await SaveBlockedTimesAsync();
            await GetInvitationAsync(CancellationToken.None);
        }
    }

    private string GetResendButtonText(string email)
    {
        if (!IsResendBlocked(email))
            return "Reenviar";

        var remaining = resendBlockedUntil[email] - DateTime.Now;

        if (remaining <= TimeSpan.Zero)
            return "Reenviar";

        return $"Podrás reenviar en {remaining.Minutes:D2}:{remaining.Seconds:D2}";
    }

    private bool IsResendBlocked(string email)
    {
        return resendBlockedUntil.TryGetValue(email, out var blockedUntil)
               && DateTime.Now < blockedUntil;
    }

    public new void Dispose()
    {
        _timerCts.Cancel();
        _timer?.Dispose();
        _timerCts.Dispose();

        base.Dispose();
    }
}