@page "/usermanager"
@inject AppHeaderStateHandler AppHeaderStateHandler
@inject IFitTechApiClientV2 ApiClient
@inject ILogger<CustomerManager> Logger
@inject IFitTechSnackbarService SnackbarService

@using System.ComponentModel.DataAnnotations
@using Blazor.Heroicons
@using FitTech.API.Client.ClientV2
@using FitTech.ApiClient.Generated
@using FitTech.WebComponents.Components.AppHeader
@using FitTech.WebComponents.Components.Buttons
@using FitTech.WebComponents.Components.Inputs
@using FitTech.WebComponents.Components.Modals
@using FitTech.WebComponents.Components.Snackbar
@using FitTech.WebComponents.Styles.Enums

<EditForm Model="Model" OnValidSubmit="SubmitAsync">
    <DataAnnotationsValidator/>
    <FitTechModal @ref="_modal">
        <FitTechModalHeader>
            Invitar Cliente
            <p class="text-xs font-light text-fittech-gray-secondary text-wrap max-w-sm pt-[6px]">Envía una invitación a
                un cliente para poder iniciar el seguimiento</p>
        </FitTechModalHeader>
        <FitTechModalBody>
            <FitTechInput class="w-full" Placeholder="Email" @bind-Value="@Model!.Email"/>
            <ValidationMessage For="@(() => Model!.Email)" class="pt-[4px] text-fittech-red text-xs"/>
        </FitTechModalBody>
        <FitTechModalFooter>
            <FitTechButton Type="ButtonType.Submit" Color="Color.Primary" Label="Enviar"
                           Icon="@HeroiconName.InboxArrowDown"/>
        </FitTechModalFooter>
    </FitTechModal>
</EditForm>

@code {
    private FitTechModal _modal = null!;
    [SupplyParameterFromForm] public ClientInvitationModel? Model { get; set; }

    protected override void OnInitialized()
    {
        Model ??= new();

        AppHeaderStateHandler.Clear();
        AppHeaderStateHandler.AddButton(HeroiconName.Plus, EventCallback.Factory.Create<MouseEventArgs>(this, HandleClick), "Añadir usuario");

        base.OnInitialized();
    }

    private void HandleClick(MouseEventArgs e)
    {
        _modal.Open();
    }

    public async Task SubmitAsync()
    {
        var result = await ApiClient.Trainer.SendInvitationAsync(new InviteClientRequest()
        {
            ClientEmail = Model!.Email
        }, CancellationToken.None);

        if (!result.IsSuccessful)
        {
            SnackbarService.Add(new FitTechSnackbar()
            {
                Message = "Se ha producido un error, intentalo otra vez",
                Type = SnackbarType.Error
            });
            Logger.LogError($"Error sending invitation: {result}");
        }
        
        SnackbarService.Add(new FitTechSnackbar()
        {
            Message = $"Se ha enviado la invitación a {Model!.Email} correctamente",
            Type = SnackbarType.Success
        });
        Model = new();
    }

    public class ClientInvitationModel
    {
        [Required(ErrorMessage = "El email es obligatorio")]
        [EmailAddress(ErrorMessage = "El email no es válido")]
        public string Email { get; set; } = null!;
    }

}
